name: desifaces

x-common-env: &common_env
  env_file:
    - ./infra/.env

x-common-python-service: &python_service
  <<: *common_env
  init: true
  restart: unless-stopped
  stop_grace_period: 20s
  networks: [df-net]
  depends_on:
    desifaces-db:
      condition: service_healthy
    desifaces-redis:
      condition: service_started
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  # -------------------------
  # Database
  # -------------------------
  desifaces-db:
    image: pgvector/pgvector:pg16
    container_name: desifaces-db
    networks: [df-net]
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-desifaces}
      POSTGRES_USER: ${POSTGRES_USER:-desifaces_admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-desifaces_mahadev}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "15432:5432"
    volumes:
      - df_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "3" }

  # -------------------------
  # Redis
  # -------------------------
  desifaces-redis:
    image: redis:7-alpine
    container_name: desifaces-redis
    networks: [df-net]
    expose:
      - "6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - df_redisdata:/data
    restart: unless-stopped
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "3" }

  # -------------------------
  # Core API
  # -------------------------
  svc-core:
    <<: *python_service
    container_name: df-svc-core
    build:
      context: ./services/svc-core/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PORT: "8000"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      JWT_HMAC_SECRET: ${JWT_HMAC_SECRET}
      REFRESH_TOKEN_HMAC_SECRET: ${REFRESH_TOKEN_HMAC_SECRET}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}
      PYTHONPATH: "/app"
    expose: ["8000"]
    ports: ["8000:8000"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 15s

  # -------------------------
  # Fusion API
  # -------------------------
  svc-fusion:
    <<: *python_service
    container_name: df-svc-fusion
    build:
      context: ./services/svc-fusion/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PORT: "8002"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      PYTHONPATH: "/app"

      DF_FUSION_STUDIO_ENABLED: ${DF_FUSION_STUDIO_ENABLED:-true}

      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_HMAC_SECRET: ${JWT_HMAC_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      HEYGEN_API_KEY: ${DF_HEYGEN_API_KEY}
      HEYGEN_BASE_URL: ${DF_HEYGEN_BASE_URL:-https://api.heygen.com}
    expose: ["8002"]
    ports: ["8002:8002"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  # -------------------------
  # Fusion Worker
  # -------------------------
  svc-fusion-worker:
    <<: *python_service
    container_name: df-svc-fusion-worker
    build:
      context: ./services/svc-fusion/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      PYTHONPATH: "/app"

      HEYGEN_API_KEY: ${DF_HEYGEN_API_KEY}
      HEYGEN_BASE_URL: ${DF_HEYGEN_BASE_URL:-https://api.heygen.com}

      DF_FUSION_STUDIO_ENABLED: ${DF_FUSION_STUDIO_ENABLED:-true}

      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_HMAC_SECRET: ${JWT_HMAC_SECRET}
      REFRESH_TOKEN_HMAC_SECRET: ${REFRESH_TOKEN_HMAC_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}
    command: ["bash", "-lc", "python -m app.workers.fusion_worker"]

  # -------------------------
  # Face API
  # -------------------------
  svc-face:
    <<: *python_service
    container_name: df-svc-face
    build:
      context: ./services/svc-face/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PORT: "8003"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      FACE_OUTPUT_CONTAINER: ${FACE_OUTPUT_CONTAINER:-face-output}
      PYTHONPATH: "/app"

      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      FAL_API_KEY: ${FAL_API_KEY}
      FAL_MODEL: ${FAL_MODEL:-fal-ai/flux-pro/v1.1}

      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT}
      AZURE_OPENAI_KEY: ${AZURE_OPENAI_KEY}
      AZURE_OPENAI_DEPLOYMENT: ${AZURE_OPENAI_DEPLOYMENT}

      AZURE_CONTENT_MODERATOR_ENDPOINT: ${AZURE_CONTENT_MODERATOR_ENDPOINT}
      AZURE_CONTENT_MODERATOR_KEY: ${AZURE_CONTENT_MODERATOR_KEY}
    expose: ["8003"]
    ports: ["8003:8003"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  # -------------------------
  # Face Worker
  # -------------------------
  svc-face-worker:
    <<: *python_service
    container_name: df-svc-face-worker
    build:
      context: ./services/svc-face/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      FACE_OUTPUT_CONTAINER: ${FACE_OUTPUT_CONTAINER:-face-output}
      PYTHONPATH: "/app"

      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}

      FAL_API_KEY: ${FAL_API_KEY}
      FAL_MODEL: ${FAL_MODEL:-fal-ai/flux-pro/v1.1}

      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT}
      AZURE_OPENAI_KEY: ${AZURE_OPENAI_KEY}
      AZURE_OPENAI_DEPLOYMENT: ${AZURE_OPENAI_DEPLOYMENT}

      AZURE_CONTENT_MODERATOR_ENDPOINT: ${AZURE_CONTENT_MODERATOR_ENDPOINT}
      AZURE_CONTENT_MODERATOR_KEY: ${AZURE_CONTENT_MODERATOR_KEY}
    command: ["bash", "-lc", "python -m app.workers.face_worker"]

  # -------------------------
  # Commerce API
  # -------------------------
  svc-commerce:
    <<: *python_service
    container_name: df-svc-commerce
    build:
      context: ./services/svc-commerce/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PORT: "8008"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      PYTHONPATH: "/app"

      # JWT (match svc-core signing/claims)
      JWT_SECRET: ${JWT_SECRET}
      JWT_HMAC_SECRET: ${JWT_HMAC_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      # Pricing stub knobs (svc-pricing later)
      PRICING_SERVICE_URL: ${PRICING_SERVICE_URL:-}
      COMMERCE_QUOTE_TTL_SECONDS: ${COMMERCE_QUOTE_TTL_SECONDS:-900}
      COMMERCE_CREDIT_USD_RATE: ${COMMERCE_CREDIT_USD_RATE:-0.03}
      COMMERCE_CREDIT_INR_RATE: ${COMMERCE_CREDIT_INR_RATE:-2.5}
      COMMERCE_CREDITS_PER_IMAGE: ${COMMERCE_CREDITS_PER_IMAGE:-30}
      COMMERCE_CREDITS_PER_VIDEO: ${COMMERCE_CREDITS_PER_VIDEO:-120}
      COMMERCE_CREDITS_PER_CHANNEL_EXPORT: ${COMMERCE_CREDITS_PER_CHANNEL_EXPORT:-10}
      COMMERCE_CREDITS_MARKETPLACE_PACK: ${COMMERCE_CREDITS_MARKETPLACE_PACK:-25}

      # Providers (optional now; wire later)
      FAL_API_KEY: ${FAL_API_KEY:-}
      FAL_MODEL: ${FAL_MODEL:-fal-ai/flux-pro/v1.1}

      # Optional service-to-service (future use)
      SVC_FUSION_BASE_URL: ${SVC_FUSION_BASE_URL:-http://df-svc-fusion:8002}
      SVC_AUDIO_BASE_URL: ${SVC_AUDIO_BASE_URL:-http://df-svc-audio:8004}

    command: ["bash", "-lc", "uvicorn app.main:app --host 0.0.0.0 --port $${PORT:-8008}"]
    expose: ["8008"]
    ports: ["8008:8008"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  # -------------------------
  # Commerce Worker
  # -------------------------
  svc-commerce-worker:
    <<: *python_service
    container_name: df-svc-commerce-worker
    build:
      context: ./services/svc-commerce/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      PYTHONPATH: "/app"

      # JWT (match svc-core signing/claims)
      JWT_SECRET: ${JWT_SECRET}
      JWT_HMAC_SECRET: ${JWT_HMAC_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      # Pricing stub knobs (svc-pricing later)
      PRICING_SERVICE_URL: ${PRICING_SERVICE_URL:-}
      COMMERCE_QUOTE_TTL_SECONDS: ${COMMERCE_QUOTE_TTL_SECONDS:-900}
      COMMERCE_CREDIT_USD_RATE: ${COMMERCE_CREDIT_USD_RATE:-0.03}
      COMMERCE_CREDIT_INR_RATE: ${COMMERCE_CREDIT_INR_RATE:-2.5}
      COMMERCE_CREDITS_PER_IMAGE: ${COMMERCE_CREDITS_PER_IMAGE:-30}
      COMMERCE_CREDITS_PER_VIDEO: ${COMMERCE_CREDITS_PER_VIDEO:-120}
      COMMERCE_CREDITS_PER_CHANNEL_EXPORT: ${COMMERCE_CREDITS_PER_CHANNEL_EXPORT:-10}
      COMMERCE_CREDITS_MARKETPLACE_PACK: ${COMMERCE_CREDITS_MARKETPLACE_PACK:-25}

      # Providers (optional now; wire later)
      FAL_API_KEY: ${FAL_API_KEY:-}
      FAL_MODEL: ${FAL_MODEL:-fal-ai/flux-pro/v1.1}

      # Worker tuning (optional)
      WORKER_POLL_SECS: ${COMMERCE_WORKER_POLL_SECS:-1.5}
      WORKER_BATCH_SIZE: ${COMMERCE_WORKER_BATCH_SIZE:-1}

    command: ["bash", "-lc", "python -m app.workers.commerce_worker"]

  # -------------------------
  # Audio API
  # -------------------------
  svc-audio:
    <<: *python_service
    container_name: df-svc-audio
    build:
      context: ./services/svc-audio/app
      dockerfile: Dockerfile
    image: desifaces-svc-audio
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PORT: "8004"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      PYTHONPATH: "/app"

      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}
      JWT_ALG: ${JWT_ALG:-HS256}

      AZURE_SPEECH_KEY: ${AZURE_SPEECH_KEY}
      AZURE_SPEECH_REGION: ${AZURE_SPEECH_REGION:-eastus}
      AZURE_TRANSLATOR_KEY: ${AZURE_TRANSLATOR_KEY}
      AZURE_TRANSLATOR_ENDPOINT: ${AZURE_TRANSLATOR_ENDPOINT:-https://api.cognitive.microsofttranslator.com}
      AZURE_TRANSLATOR_REGION: ${AZURE_TRANSLATOR_REGION:-eastus}

      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AUDIO_OUTPUT_CONTAINER: ${AUDIO_OUTPUT_CONTAINER:-audio-output}
      AUDIO_SAS_HOURS: ${AUDIO_SAS_HOURS:-24}
    expose: ["8004"]
    ports: ["8004:8004"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  # -------------------------
  # Audio Worker
  # -------------------------
  svc-audio-worker:
    <<: *python_service
    container_name: df-svc-audio-worker
    build:
      context: ./services/svc-audio/app
      dockerfile: Dockerfile
    image: desifaces-svc-audio
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      PYTHONPATH: "/app"

      AUDIO_STUDIO_TYPE: "audio"
      WORKER_POLL_SECS: "1.5"
      WORKER_BATCH_SIZE: "1"

      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}
      JWT_ALG: ${JWT_ALG:-HS256}

      AZURE_SPEECH_KEY: ${AZURE_SPEECH_KEY}
      AZURE_SPEECH_REGION: ${AZURE_SPEECH_REGION:-eastus}
      AZURE_TRANSLATOR_KEY: ${AZURE_TRANSLATOR_KEY}
      AZURE_TRANSLATOR_ENDPOINT: ${AZURE_TRANSLATOR_ENDPOINT:-https://api.cognitive.microsofttranslator.com}
      AZURE_TRANSLATOR_REGION: ${AZURE_TRANSLATOR_REGION:-eastus}

      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AUDIO_OUTPUT_CONTAINER: ${AUDIO_OUTPUT_CONTAINER:-audio-output}
      AUDIO_SAS_HOURS: ${AUDIO_SAS_HOURS:-24}
    command: ["bash", "-lc", "python -m app.workers.audio_worker"]

  # -------------------------
  # Dashboard API
  # -------------------------
  svc-dashboard:
    <<: *python_service
    container_name: df-svc-dashboard
    build:
      context: ./services/svc-dashboard/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      HOST: "0.0.0.0"
      PORT: "8005"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      PYTHONPATH: "/app/app"
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: "HS256"
      DASHBOARD_STALE_SECONDS: ${DASHBOARD_STALE_SECONDS:-30}
      DASHBOARD_FORCE_REFRESH_ON_MISS: ${DASHBOARD_FORCE_REFRESH_ON_MISS:-true}
    expose: ["8005"]
    ports: ["8005:8005"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  svc-dashboard-worker:
    <<: *python_service
    container_name: df-svc-dashboard-worker
    build:
      context: ./services/svc-dashboard/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      PYTHONPATH: "/app/app"
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: "HS256"
      DASHBOARD_WORKER_ENABLED: "true"
      DASHBOARD_WORKER_POLL_SECONDS: ${DASHBOARD_WORKER_POLL_SECONDS:-0.75}
      DASHBOARD_WORKER_BATCH_SIZE: ${DASHBOARD_WORKER_BATCH_SIZE:-50}
    command: ["bash", "-lc", "python -m app.worker.refresh_worker"]

  # -------------------------
  # Fusion Extension (Longform) API
  # -------------------------
  svc-fusion-extension:
    <<: *python_service
    container_name: df-svc-fusion-extension
    build:
      context: ./services/svc-fusion-extension/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PORT: "8006"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      PYTHONPATH: "/app"

      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      SVC_FUSION_BASE_URL: ${SVC_FUSION_BASE_URL:-http://df-svc-fusion:8002}
      SVC_AUDIO_BASE_URL: ${SVC_AUDIO_BASE_URL:-http://df-svc-audio:8004}
      SVC_TO_SVC_BEARER: ${SVC_TO_SVC_BEARER}

      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AZURE_FINAL_VIDEO_CONTAINER: ${AZURE_FINAL_VIDEO_CONTAINER:-video-output}
      FINAL_SAS_TTL_SECONDS: ${FINAL_SAS_TTL_SECONDS:-1296000}

      DEFAULT_SEGMENT_SECONDS: ${DEFAULT_SEGMENT_SECONDS:-60}
      MAX_SEGMENT_SECONDS: ${MAX_SEGMENT_SECONDS:-120}
      MAX_INFLIGHT_SEGMENTS_PER_JOB: ${MAX_INFLIGHT_SEGMENTS_PER_JOB:-2}
      MAX_TOTAL_SEGMENTS_PER_JOB: ${MAX_TOTAL_SEGMENTS_PER_JOB:-500}

      AUDIO_POLL_SECONDS: ${AUDIO_POLL_SECONDS:-1.5}
      AUDIO_TIMEOUT_SECONDS: ${AUDIO_TIMEOUT_SECONDS:-300}
      FUSION_POLL_SECONDS: ${FUSION_POLL_SECONDS:-3.0}
      FUSION_TIMEOUT_SECONDS: ${FUSION_TIMEOUT_SECONDS:-900}
    expose: ["8006"]
    ports: ["8006:8006"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  svc-fusion-extension-worker:
    <<: *python_service
    container_name: df-svc-fusion-extension-worker
    build:
      context: ./services/svc-fusion-extension/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      PYTHONPATH: "/app"

      SVC_TO_SVC_BEARER: ${SVC_TO_SVC_BEARER}

      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      SVC_FUSION_BASE_URL: ${SVC_FUSION_BASE_URL:-http://df-svc-fusion:8002}
      SVC_AUDIO_BASE_URL: ${SVC_AUDIO_BASE_URL:-http://df-svc-audio:8004}

      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AZURE_FINAL_VIDEO_CONTAINER: ${AZURE_FINAL_VIDEO_CONTAINER:-video-output}
      FINAL_SAS_TTL_SECONDS: ${FINAL_SAS_TTL_SECONDS:-1296000}

      WORKER_ENABLED: "true"
      WORKER_POLL_SECONDS: ${WORKER_POLL_SECONDS:-1.0}
      WORKER_BATCH_SIZE: ${WORKER_BATCH_SIZE:-10}

      DEFAULT_SEGMENT_SECONDS: ${DEFAULT_SEGMENT_SECONDS:-60}
      MAX_SEGMENT_SECONDS: ${MAX_SEGMENT_SECONDS:-120}
      MAX_INFLIGHT_SEGMENTS_PER_JOB: ${MAX_INFLIGHT_SEGMENTS_PER_JOB:-2}
      MAX_TOTAL_SEGMENTS_PER_JOB: ${MAX_TOTAL_SEGMENTS_PER_JOB:-500}

      AUDIO_POLL_SECONDS: ${AUDIO_POLL_SECONDS:-1.5}
      AUDIO_TIMEOUT_SECONDS: ${AUDIO_TIMEOUT_SECONDS:-300}
      FUSION_POLL_SECONDS: ${FUSION_POLL_SECONDS:-3.0}
      FUSION_TIMEOUT_SECONDS: ${FUSION_TIMEOUT_SECONDS:-900}
    command: ["bash", "-lc", "python -m app.workers.longform_worker"]

  svc-fusion-extension-stitch-worker:
    <<: *python_service
    container_name: df-svc-fusion-extension-stitch-worker
    build:
      context: ./services/svc-fusion-extension/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      PYTHONPATH: "/app"

      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AZURE_FINAL_VIDEO_CONTAINER: ${AZURE_FINAL_VIDEO_CONTAINER:-video-output}
      FINAL_SAS_TTL_SECONDS: ${FINAL_SAS_TTL_SECONDS:-1296000}

      STITCH_WORKER_ENABLED: "true"
      STITCH_WORKER_POLL_SECONDS: ${STITCH_WORKER_POLL_SECONDS:-2.0}
      STITCH_WORKER_BATCH_SIZE: ${STITCH_WORKER_BATCH_SIZE:-2}
    command: ["bash", "-lc", "python -m app.workers.stitch_worker"]

  # -------------------------
  # Music API
  # -------------------------
  svc-music:
    <<: *python_service
    container_name: df-svc-music
    build:
      context: ./services/svc-music/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/app"

      # Standardize internal port across services
      PORT: "8000"

      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}

      # JWT (MUST match svc-core signing/claims)
      JWT_SECRET: ${JWT_SECRET}
      JWT_HMAC_SECRET: ${JWT_HMAC_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      MUSIC_OUTPUT_CONTAINER: ${MUSIC_OUTPUT_CONTAINER:-music-output}
      MUSIC_SAS_HOURS: ${MUSIC_SAS_HOURS:-24}
      
      HEYGEN_API_KEY: ${DF_HEYGEN_API_KEY}
      HEYGEN_BASE_URL: ${DF_HEYGEN_BASE_URL:-https://api.heygen.com}

      # Cross-service (Docker network) â€” ALWAYS use :8000 internally
      SVC_FACE_URL: ${SVC_FACE_URL:-http://svc-face:8000}
      SVC_FACE_BEARER_TOKEN: ${SVC_FACE_BEARER_TOKEN:-}

      # Optional tuning knobs (safe defaults)
      SVC_FACE_TIMEOUT_SECS: ${SVC_FACE_TIMEOUT_SECS:-60}
      SVC_FACE_POLL_SECS: ${SVC_FACE_POLL_SECS:-2}
      SVC_FACE_WAIT_TIMEOUT_SECS: ${SVC_FACE_WAIT_TIMEOUT_SECS:-180}

    command: ["bash", "-lc", "uvicorn app.main:app --host 0.0.0.0 --port $${PORT}"]
    expose: ["8000"]
    ports: ["8007:8000"]

    init: true
    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:$${PORT}/api/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 25s

  # -------------------------
  # Music Worker
  # -------------------------
  svc-music-worker:
    <<: *python_service
    container_name: df-svc-music-worker
    build:
      context: ./services/svc-music/app
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/app"

      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}

      JWT_SECRET: ${JWT_SECRET}
      JWT_HMAC_SECRET: ${JWT_HMAC_SECRET}
      JWT_ALG: ${JWT_ALG:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-desifaces}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-desifaces_clients}

      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      MUSIC_OUTPUT_CONTAINER: ${MUSIC_OUTPUT_CONTAINER:-music-output}
      MUSIC_SAS_HOURS: ${MUSIC_SAS_HOURS:-24}

      HEYGEN_API_KEY: ${DF_HEYGEN_API_KEY}
      HEYGEN_BASE_URL: ${DF_HEYGEN_BASE_URL:-https://api.heygen.com}

      WORKER_POLL_SECS: ${MUSIC_WORKER_POLL_SECS:-1.5}

      # Cross-service (Docker network)
      SVC_FACE_URL: ${SVC_FACE_URL:-http://svc-face:8000}
      SVC_FACE_TIMEOUT_SECS: ${SVC_FACE_TIMEOUT_SECS:-60}
      SVC_FACE_POLL_SECS: ${SVC_FACE_POLL_SECS:-2}
      SVC_FACE_WAIT_TIMEOUT_SECS: ${SVC_FACE_WAIT_TIMEOUT_SECS:-180}
      SVC_FACE_BEARER_TOKEN: ${SVC_FACE_BEARER_TOKEN:-}

    init: true
    restart: unless-stopped

    command: ["bash", "-lc", "python -m app.workers.music_worker"]

networks:
  df-net:
    name: df-net
    driver: bridge

volumes:
  df_pgdata:
  df_redisdata: