from __future__ import annotations

import json
from typing import Any, Dict, Optional

import asyncpg


class ArtifactsRepo:
    def __init__(self, pool: asyncpg.Pool) -> None:
        self.pool = pool

    async def add_artifact(
        self,
        job_id: str,
        kind: str,
        url: str,
        *,
        content_type: Optional[str] = None,
        meta_json: Optional[Dict[str, Any]] = None,
    ) -> None:
        q = """
        INSERT INTO artifacts (job_id, kind, url, content_type, meta_json)
        VALUES ($1, $2, $3, $4, $5::jsonb)
        """
        payload = meta_json if meta_json is not None else {}
        payload_str = json.dumps(payload, ensure_ascii=False)

        async with self.pool.acquire() as conn:
            await conn.execute(q, job_id, kind, url, content_type, payload_str)